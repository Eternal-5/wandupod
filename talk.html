<script>
  // ① Firebase 설정
  const firebaseConfig = {
    apiKey: "AIzaSyCpUti20pb1a5qAMvCqWh3FJpn7MDDb8",
    authDomain: "wandupod.firebaseapp.com",
    projectId: "wandupod",
    storageBucket: "wandupod.appspot.com",
    messagingSenderId: "896164102070",
    appId: "1:896164102070:web:6c3a477d1abcbb5c040b17",
    measurementId: "G-VEN0MHF4HR"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ② Netlify Identity 초기화
  netlifyIdentity.init();
  const $login  = document.getElementById('login');
  const $logout = document.getElementById('logout');
  const $send   = document.getElementById('send');
  const $chat   = document.getElementById('chat');
  const $msg    = document.getElementById('msg');
  let   nick    = '';

  $login.onclick  = () => netlifyIdentity.open('login');
  $logout.onclick = () => netlifyIdentity.logout();

  netlifyIdentity.on('login', user => {
    nick = '콩알' + Math.floor(Math.random() * 9000 + 1000);
    $login.style.display  = 'none';
    $logout.style.display = 'inline';
    $send.style.display   = 'flex';
    netlifyIdentity.close();
  });

  netlifyIdentity.on('logout', () => location.reload());

  // ③ 실시간 메시지 표시
  db.collection('messages').orderBy('timestamp')
    .onSnapshot(snap => {
      $chat.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const li = document.createElement('li');
        li.textContent = `${d.userId} : ${d.message}`;
        $chat.appendChild(li);
      });
      $chat.scrollTop = $chat.scrollHeight;
    });

  // ④ 메시지 전송
  $send.addEventListener('submit', e => {
    e.preventDefault();
    if (!$msg.value.trim()) return;
    db.collection('messages').add({
      userId: nick,
      message: $msg.value.trim(),
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    $msg.value = '';
  });
</script>
